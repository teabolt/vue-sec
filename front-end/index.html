<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Vue Sec</title>
  <link rel="stylesheet" type="text/css" href="./styles.css">
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
  <div id="app">
    <span v-if="networkError" class="error">{{ networkError }}</span>
    <div id="new-review">
      <span>New Review:</span>
      <form>
        <ul class="form-items">
          <li class="form-item">
            <label for="title">Title:</label>
            <input
              v-model="reviewTitle"
              type="text"
              id="review-title"
              name="title"
              required="true"
              maxlength="20"
            >    
          </li>
          <li class="form-item">
            <label for="description">Message:</label>
            <textarea
              v-model="reviewMessage"
              id="review-description"
              name="description"
              required="true"
              rows="6"
            >
            </textarea>
          </li>
          <li class="form-item">
            <button v-on:click.prevent="onSubmit">Add review</button>
            <span v-if="error" class="error">{{ error }}</span>
          </li>
        </ul>
      </form>
    </div>
    <div id="reviews">
      <span>All Reviews:</span>
      <ul v-if="reviews && reviews.length" class="review-items">
        <li v-for="review in reviews" class="review-item">
          <div class="review">
            <div class="title">
              {{ review.title }}
            </div>
            <div class="description">
              {{ review.description }}
            </div>
          </div>
        </li>
      </ul>
      <p v-else>No reviews for now...</p>
    </div>
  </div>

  <script>
    const reviewsUrl = 'http://127.0.0.1:3000/';

    async function getReviews() {
      const res = await fetch(reviewsUrl);
      if (!res.ok) {
          return Promise.Reject(res.status);
        }
      return await res.json();;
    }

    async function newReview(review) {
      const res = await fetch(reviewsUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `title=${encodeURIComponent(review.title)}` +
                `&description=${encodeURIComponent(review.description)}`,
      });
      if (!res.ok) {
        return Promise.Reject(res.status);
      }
      return res;
    }

    var vm = new Vue({
      el: "#app",
      data: {
          reviewTitle: "",
          reviewMessage: "",
          reviews: null,
          error: "",
          networkError: "",
      },
      methods: {
        onSubmit: async function (event) {
          if (!this.reviewTitle) {
            this.error = "Missing value for title";
          } else if (!this.reviewMessage) {
            this.error = "Missing value for description";
          } else {
            this.error = "";
          }

          if (this.error) {
            return;
          }

          try {
            newReview({
              title: this.reviewTitle,
              description: this.reviewMessage,
            });
          } catch (error) {
            this.networkError = String(error);
          }

          try {
            this.reviews = await getReviews();
          } catch (error) {
            this.networkError = String(error);
          }
        },
      },
      async mounted () {
        try {
          this.reviews = await getReviews();
        } catch (error) {
          this.networkError = String(error);
        }
      },
    });
  </script>
</body>
</html>
